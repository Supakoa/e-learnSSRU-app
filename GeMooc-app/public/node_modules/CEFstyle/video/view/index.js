let videoId = getId(video.data);
let iframeMarkup = 'www.youtube.com/embed/' + videoId;
let inputSrc;

function getId(url) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    var match = url.match(regExp);

    if (match && match[2].length == 11) {
        return match[2];
    } else {
        return 'error';
    }
}

if (video.type == 'file') {
    inputSrc = dataVideo;
} else {
    inputSrc = iframeMarkup;
}

// set into src iframe
$('#showVideo').attr('src', 'https://' + inputSrc);

if (video.type == 'youtube') {
    player = new Plyr(document.getElementById('player1'));
    console.log('youtube');

} else {
    player = new Plyr(document.getElementById('player2'));
    console.log('file');
}

// test send record
function takeRecord() {
    $("#recordItem").val(JSON.stringify(videoRecord));
}

$(document).ready(function () {
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });
});

$('#player1').on('ready', function () {
    /**
        Omega magneto hello function
    */
    let i = j = 0;
    let iHaveTimer = false;
    let buffer = new Array(player.duration);

    // creat new record bar
    for (let i = 0; i < player.duration; i++) {
        var second = parseInt(i % 60);
        var minute = parseInt(i / 60);
        (second < 10) ? second = '0' + second: second;
        (minute < 10) ? minute = '0' + minute: minute;
        var newLi = document.createElement('div');
        newLi.className = 'recordSlot';
        newLi.style.width = ($('#player1').width()) / player.duration + 'px';
        newLi.setAttribute('at_record', i);
        newLi.setAttribute('status', 'undefind');
        newLi.setAttribute('data-toggle', 'tooltip');
        newLi.setAttribute('data-placement', 'bottom');
        newLi.setAttribute('title', minute + ':' + second);
        newLi.onclick = function () {
            console.log('currentTime: ' + i);
            player.currentTime = i;
            click = true;
        }
        console.log('object :' + ($('#player1').width()));
        document.getElementById('navProgress').appendChild(newLi);
    }

    // check player duration
    console.log('duration: ' + player.duration);

    // new empty videoRecord
    let videoRecord = {
        "content_id": content.id,
        "user_id": userId,
        "record": buffer,
        "percent": 0,
    }

    // if have in old record will take to videoRecord
    if (issetRecord) {
        console.log('have record..');
        videoRecord = {
            "content_id": content.id,
            "user_id": userId,
            "record": JSON.parse(record.record),
            "percent": record.percent,
        }
        // take record to buffer
        buffer = JSON.parse(record.record);
        // console.log('videoRecord: ' + videoRecord.record[0] );
    }

    // show videoRecord
    $("#text").text(JSON.stringify(videoRecord));

    // oneRady start interval
    $("body").on("ready", function () {
        console.log('ready..');

        // interval use for save videoRecorder to database
        setInterval(function () {
            $.post("/record", {
                    'muuwan': JSON.stringify(videoRecord)
                },
                function (data, textStatus, jqXHR) {
                    console.log('store ..' + data);
                },
            );
        }, 5000);
    });

    $("#player1, .recordSlot").on("play", function () {
            console.log('fucking click..');
            // get current time from player
            i = Math.floor(player.currentTime);
            j = i;

            // check have only one interval
            if (!iHaveTimer) {

                // create new interval
                var timer = setInterval(function () {
                    j = i;
                    i = Math.floor(player.currentTime);

                    // get val to videoRecord
                    const tim = Math.floor(player.currentTime);
                    buffer[tim] = tim;
                    videoRecord.record = buffer;
                    videoRecord.percent = Math.floor(((buffer.filter(String).length) / player.duration) * 100);

                    // when stop player do clear interval
                    if (!player.playing) {
                        console.log('stop..');
                        clearInterval(timer);
                        iHaveTimer = false;
                    }

                    // i/o to show val
                    $("#text").text(JSON.stringify(videoRecord));
                    console.log((i++) + " : " + j);
                    console.log(timer);
                }, 1000 / player.speed);

                // return to stop make new interval
                iHaveTimer = true;
            }
    });
});
